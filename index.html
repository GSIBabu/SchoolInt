<!DOCTYPE html> 
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·Éì·Éù·É£·Éë·Éê·Éú·Éî·Éö·Éò·Éñ·Éê·É¢·Éù·É†·Éò ·É°·Éê·É°·Éô·Éù·Éö·Éù ·É†·Éê·Éñ·Éï·Éî·Éì·Éô·Éê</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="favicon.ico">
    <style>
        :root {
            --color-black: #1e1e1e;
            --color-white: #f8f8f8;
            --color-ocean-blue: #3a9ed8;
            --color-ocean-blue-light: #53b7ec;
            --color-ocean-blue-dark: #2a7ca8;
            --color-ocean-blue-transparent: rgba(58, 158, 216, 0.1);
            --color-gray-light: #f0f0f0;
            --color-gray: #c4c4c4;
            --color-gray-dark: #606060;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'BPG Arial', sans-serif;
        }
        
        body {
            background-color: var(--color-white);
            color: var(--color-black);
        }
        
        /* Loading spinner */
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(248, 248, 248, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            border: 5px solid var(--color-gray);
            border-top: 5px solid var(--color-ocean-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Header */
        header {
            background-color: var(--color-black);
            color: var(--color-white);
            padding: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .header-content {
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
        }
        
        @media (min-width: 768px) {
            .header-content {
                flex-direction: row;
            }
        }
        
        .app-title {
            font-size: 1.75rem;
            font-weight: bold;
            margin-bottom: 1rem;
        }
        
        @media (min-width: 768px) {
            .app-title {
                margin-bottom: 0;
            }
        }
        
        .upload-btn {
            background-color: var(--color-ocean-blue);
            color: var(--color-white);
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .upload-btn:hover {
            background-color: var(--color-ocean-blue-light);
        }
        
        /* Welcome Screen */
        .welcome-screen {
            text-align: center;
            padding: 5rem 1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .welcome-icon {
            width: 6rem;
            height: 6rem;
            margin: 0 auto 1.5rem;
            color: var(--color-ocean-blue);
        }
        
        .welcome-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--color-black);
        }
        
        .welcome-desc {
            color: var(--color-gray-dark);
            margin-bottom: 2rem;
        }
        
        /* Main Content */
        main {
            padding: 2rem 1rem;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        @media (min-width: 640px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .stat-card {
            background-color: var(--color-white);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            border: 1px solid var(--color-gray-light);
        }
        
        .stat-title {
            font-size: 0.875rem;
            color: var(--color-gray-dark);
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--color-black);
            display: flex;
            align-items: center;
        }
        
        .stat-unit {
            font-size: 0.875rem;
            color: var(--color-gray-dark);
            margin-left: 0.25rem;
        }
        
        /* Layout Grid */
        .content-grid {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        @media (min-width: 1024px) {
            .content-grid {
                flex-direction: row;
            }
            
            .filter-panel {
                flex: 1;
                max-width: 400px;
            }
            
            .results-panel {
                flex: 2;
            }
        }
        
        /* Filter Panel */
        .panel {
            background-color: var(--color-white);
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 1px solid var(--color-gray-light);
        }
        
        .panel-header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-gray-light);
        }
        
        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--color-black);
        }
        
        .reset-btn {
            background: none;
            border: none;
            color: var(--color-ocean-blue);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .reset-btn:hover {
            color: var(--color-ocean-blue-light);
        }
        
        .panel-body {
            padding: 1.5rem;
        }
        
        .filter-group {
            margin-bottom: 1.5rem;
        }
        
        .filter-group:last-child {
            margin-bottom: 0;
        }
        
        .filter-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--color-black);
            margin-bottom: 0.75rem;
            display: block;
        }
        
        .range-slider-container {
            margin-bottom: 1rem;
        }
        
        .range-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--color-gray-dark);
            margin-bottom: 0.5rem;
        }
        
        input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--color-gray);
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-ocean-blue);
            cursor: pointer;
            border: 2px solid var(--color-white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--color-ocean-blue);
            cursor: pointer;
            border: 2px solid var(--color-white);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .search-input-container {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            font-size: 0.875rem;
            border: 1px solid var(--color-gray);
            border-radius: 4px;
            background-color: var(--color-white);
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--color-ocean-blue);
        }
        
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--color-gray-dark);
            width: 1rem;
            height: 1rem;
        }
        
        .checkbox-list {
            max-height: 200px;
            overflow-y: auto;
            padding-right: 0.5rem;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .checkbox-item:last-child {
            margin-bottom: 0;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin-right: 0.5rem;
            cursor: pointer;
            accent-color: var(--color-ocean-blue);
        }
        
        .checkbox-label {
            font-size: 0.875rem;
            color: var(--color-black);
            cursor: pointer;
        }
        
        /* Results Panel */
        .table-container {
            overflow-x: auto;
            max-height: 500px;
            overflow-y: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        th {
            background-color: var(--color-gray-light);
            color: var(--color-black);
            font-weight: 600;
            font-size: 0.75rem;
            text-transform: uppercase;
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--color-gray);
            cursor: pointer;
            white-space: nowrap;
        }
        
        th:hover {
            background-color: var(--color-ocean-blue-transparent);
        }
        
        td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--color-gray-light);
            font-size: 0.875rem;
            color: var(--color-black);
            white-space: nowrap;
        }
        
        tr:nth-child(even) {
            background-color: var(--color-gray-light);
        }
        
        .text-right {
            text-align: right;
        }
        
        .pagination-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--color-gray-light);
            font-size: 0.875rem;
            color: var(--color-gray-dark);
        }
        
        .pagination-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .pagination-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            background-color: var(--color-gray-light);
            border: none;
            cursor: pointer;
            color: var(--color-black);
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .pagination-btn:hover:not([disabled]) {
            background-color: var(--color-gray);
        }
        
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .export-btn {
            background-color: var(--color-ocean-blue-transparent);
            color: var(--color-ocean-blue);
            font-weight: 500;
            font-size: 0.875rem;
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .export-btn:hover {
            background-color: var(--color-ocean-blue-light);
            color: var(--color-white);
        }
        
        /* Grade Distribution Visualization */
        .grade-distribution {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .grade-bar {
            height: 20px;
            background-color: var(--color-ocean-blue-transparent);
            border-radius: 2px;
            position: relative;
            transition: height 0.3s;
            cursor: pointer;
        }
        
        .grade-bar:hover {
            background-color: var(--color-ocean-blue);
        }
        
        .grade-bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--color-gray-dark);
            white-space: nowrap;
        }
        
        .grade-bar-value {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: var(--color-ocean-blue);
            white-space: nowrap;
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .grade-bar:hover .grade-bar-value {
            opacity: 1;
        }
        
        /* Footer */
        footer {
            background-color: var(--color-black);
            color: var(--color-white);
            padding: 1.5rem;
            text-align: center;
            margin-top: 2rem;
        }
        
        .footer-text {
            font-size: 0.875rem;
            opacity: 0.8;
        }
        
        /* Facility indicators */
        .facility-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 0.5rem;
        }
        
        .facility-item {
            display: flex;
            align-items: center;
        }
        
        .facility-checkbox {
            width: 16px;
            height: 16px;
            margin-right: 0.5rem;
            accent-color: var(--color-ocean-blue);
            cursor: pointer;
        }
        
        .facility-label {
            font-size: 0.875rem;
            color: var(--color-black);
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Loading Indicator -->
    <div id="loading" class="loading">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <header>
        <div class="container">
            <div class="header-content">
                <h1 class="app-title">·Éì·Éù·É£·Éë·Éê·Éú·Éî·Éö·Éò·Éñ·Éê·É¢·Éù·É†·Éò ·É°·Éê·É°·Éô·Éù·Éö·Éù ·É†·Éê·Éñ·Éï·Éî·Éì·Éô·Éê</h1>
                <div>
                    <label for="file-upload" class="upload-btn">
                        <span>·Éê·É¢·Éï·Éò·É†·Éó·Éî·Éó CSV</span>
                        <input id="file-upload" type="file" accept=".csv" class="hidden" />
                    </label>
                </div>
            </div>
        </div>
    </header>

    <!-- Main content -->
    <main class="container">
        <!-- Initial welcome message -->
        <div id="welcome-screen" class="welcome-screen">
            <svg class="welcome-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h2 class="welcome-title">·Éõ·Éù·Éí·Éî·É°·Éê·Éö·Éõ·Éî·Éë·Éò·Éó ·É°·Éô·Éù·Éö·Éî·Éë·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éó·Éê ·Éê·Éú·Éê·Éö·Éò·Éñ·Éê·É¢·Éù·É†·É®·Éò</h2>
            <p class="welcome-desc">·Éê·É¢·Éï·Éò·É†·Éó·Éî·Éó ·É°·Éô·Éù·Éö·Éî·Éë·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° CSV ·É§·Éê·Éò·Éö·Éò ·Éê·Éú·Éê·Éö·Éò·Éñ·Éò·É°·Éê ·Éì·Éê ·É§·Éò·Éö·É¢·É†·Éê·É™·Éò·Éò·É° ·Éì·Éê·É°·Éê·É¨·Éß·Éî·Éë·Éê·Éì.</p>
            <button id="upload-btn" class="upload-btn">·Éê·É¢·Éï·Éò·É†·Éó·Éî·Éó ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò</button>
        </div>

        <!-- Data exploration interface (hidden initially) -->
        <div id="data-explorer" class="hidden">
            <!-- Stats summary -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">·É°·Éô·Éù·Éö·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê</div>
                    <div class="stat-value" id="total-schools">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·ÉØ·Éê·Éõ·É£·É†·Éò ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê</div>
                    <div class="stat-value" id="total-students">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">·É°·Éê·É®·É£·Éê·Éö·Éù ·Éë·Éò·É£·ÉØ·Éî·É¢·Éò</div>
                    <div class="stat-value">
                        <span id="avg-budget">0</span>
                        <span class="stat-unit">·Éö·Éê·É†·Éò</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">·Éú·Éê·É©·Éï·Éî·Éú·Éî·Éë·Éò ·É°·Éô·Éù·Éö·Éî·Éë·Éò</div>
                    <div class="stat-value">
                        <span id="filtered-schools">0</span>
                        <span class="stat-unit" id="filtered-percentage">(0%)</span>
                    </div>
                </div>
            </div>

            <!-- Main grid layout -->
            <div class="content-grid">
                <!-- Filters panel -->
                <div class="filter-panel">
                    <div class="panel">
                        <div class="panel-header">
                            <h2 class="panel-title">·É§·Éò·Éö·É¢·É†·Éî·Éë·Éò</h2>
                            <button id="reset-filters" class="reset-btn">·Éí·Éê·É°·É£·É§·Éó·Éê·Éï·Éî·Éë·Éê</button>
                        </div>
                        <div class="panel-body">
                            <div id="filters-container">
                                <!-- Budget filter -->
                                <div id="budget-filter" class="filter-group hidden">
                                    <label class="filter-label">·Éë·Éò·É£·ÉØ·Éî·É¢·Éò</label>
                                    <div class="range-slider-container">
                                        <div class="range-labels">
                                            <span id="budget-min-display">0</span>
                                            <span id="budget-max-display">1,000,000</span>
                                        </div>
                                        <input type="range" id="budget-slider" class="range-slider" min="0" max="1000000" value="1000000">
                                    </div>
                                </div>
                                
                                <!-- Students filter -->
                                <div id="students-filter" class="filter-group hidden">
                                    <label class="filter-label">·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê</label>
                                    <div class="range-slider-container">
                                        <div class="range-labels">
                                            <span id="students-min-display">0</span>
                                            <span id="students-max-display">1,000</span>
                                        </div>
                                        <input type="range" id="students-slider" class="range-slider" min="0" max="1000" value="1000">
                                    </div>
                                </div>
                                
                                <!-- Grade distribution filter -->
                                <div id="grade-filter" class="filter-group hidden">
                                    <label class="filter-label">·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·Éí·Éê·Éú·Éê·É¨·Éò·Éö·Éî·Éë·Éê ·Éô·Éö·Éê·É°·Éî·Éë·Éò·É° ·Éõ·Éò·ÉÆ·Éî·Éì·Éï·Éò·Éó</label>
                                    <div class="grade-distribution" id="grade-distribution">
                                        <!-- Grade bars will be dynamically added here -->
                                    </div>
                                </div>
                                
                                <!-- Facilities filter -->
                                <div id="facilities-filter" class="filter-group hidden">
                                    <label class="filter-label">·É°·Éê·É°·Éô·Éù·Éö·Éù ·Éò·Éú·É§·É†·Éê·É°·É¢·É†·É£·É•·É¢·É£·É†·Éê</label>
                                    <div class="facility-grid">
                                        <div class="facility-item">
                                            <input type="checkbox" id="lab-checkbox" class="facility-checkbox">
                                            <label for="lab-checkbox" class="facility-label">·Éö·Éê·Éë·Éù·É†·Éê·É¢·Éù·É†·Éò·Éê</label>
                                        </div>
                                        <div class="facility-item">
                                            <input type="checkbox" id="computers-checkbox" class="facility-checkbox">
                                            <label for="computers-checkbox" class="facility-label">·Éô·Éù·Éõ·Éû·Éò·É£·É¢·Éî·É†·Éî·Éë·Éò</label>
                                        </div>
                                        <div class="facility-item">
                                            <input type="checkbox" id="projector-checkbox" class="facility-checkbox">
                                            <label for="projector-checkbox" class="facility-label">·Éû·É†·Éù·Éî·É•·É¢·Éù·É†·Éò</label>
                                        </div>
                                        <div class="facility-item">
                                            <input type="checkbox" id="internet-checkbox" class="facility-checkbox">
                                            <label for="internet-checkbox" class="facility-label">·Éò·Éú·É¢·Éî·É†·Éú·Éî·É¢·Éò</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Region filter -->
                                <div id="region-filter" class="filter-group hidden">
                                    <label class="filter-label">·É†·Éî·Éí·Éò·Éù·Éú·Éò</label>
                                    <div id="region-options" class="checkbox-list">
                                        <!-- Region options will be added here -->
                                    </div>
                                </div>
                                
                                <!-- School type filter -->
                                <div id="type-filter" class="filter-group hidden">
                                    <label class="filter-label">·É°·Éô·Éù·Éö·Éò·É° ·É¢·Éò·Éû·Éò</label>
                                    <div id="type-options" class="checkbox-list">
                                        <!-- School type options will be added here -->
                                    </div>
                                </div>
                                
                                <!-- School name search -->
                                <div id="name-filter" class="filter-group">
                                    <label class="filter-label">·É°·Éô·Éù·Éö·Éò·É° ·Éì·Éê·É°·Éê·ÉÆ·Éî·Éö·Éî·Éë·Éê</label>
                                    <div class="search-input-container">
                                        <svg class="search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                        </svg>
                                        <input type="text" id="name-search" class="search-input" placeholder="·É´·Éò·Éî·Éë·Éê...">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results panel -->
                <div class="results-panel">
                    <div class="panel">
                        <div class="panel-header">
                            <h3 class="panel-title">·É°·Éô·Éù·Éö·Éî·Éë·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò</h3>
                            <button id="export-csv" class="export-btn">·Éî·É•·É°·Éû·Éù·É†·É¢·Éò CSV</button>
                        </div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr id="table-header">
                                        <!-- Table headers will be added dynamically -->
                                    </tr>
                                </thead>
                                <tbody id="table-body">
                                    <!-- Table rows will be added dynamically -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination-bar">
                            <span id="showing-entries">·Éú·Éê·É©·Éï·Éî·Éú·Éî·Éë·Éò·Éê 0-·Éì·Éê·Éú 0-·Éõ·Éì·Éî ·É©·Éê·Éú·Éê·É¨·Éî·É†·Éò</span>
                            <div class="pagination-controls">
                                <button id="prev-page" class="pagination-btn">·É¨·Éò·Éú·Éê</button>
                                <span id="page-indicator">·Éí·Éï·Éî·É†·Éì·Éò 1/1</span>
                                <button id="next-page" class="pagination-btn">·É®·Éî·Éõ·Éì·Éî·Éí·Éò</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <p class="footer-text">GSI-·É° ·Éì·Éù·É£·Éë·Éê·Éú·Éî·Éö·Éò·Éñ·Éê·É¢·Éù·É†·Éò ·É°·Éê·É°·Éô·Éù·Éö·Éù ·É†·Éê·Éñ·Éï·Éî·Éì·Éô·Éê &copy; 2025 ·É®·Éû·É° "·É°·Éê·É•·Éê·É†·Éó·Éï·Éî·Éö·Éù·É° ·É°·Éê·Éõ·Éî·É™·Éú·Éò·Éî·É†·Éù ·Éò·Éú·Éì·É£·É°·É¢·É†·Éò·Éî·Éë·Éò"</p>
        </div>
    </footer>

    <script>
        // Global variables
        let originalData = [];
        let filteredData = [];
        let currentPage = 1;
        let rowsPerPage = 20;
        
        // Wait for all resources to load
        window.addEventListener('load', function() {
            // Set up event listeners
            setupEventListeners();
        });
        // Function to update the header with a logo using base64 encoding
        function updateHeaderWithLogo() {
            // Get the header content container
            const headerContent = document.querySelector('.header-content');
            if (!headerContent) return;
            
            // REPLACE THIS COMMENT WITH YOUR BASE64 IMAGE STRING
            // Example: const logoBase64 = "data:image/png;base64,YOURENCODEDSTRINGHERE";
            const logoBase64 = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAALAAAACwCAYAAACvt+ReAAAACXBIWXMAACiaAAAomgEXOiGyAAAErGlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSfvu78nIGlkPSdXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQnPz4KPHg6eG1wbWV0YSB4bWxuczp4PSdhZG9iZTpuczptZXRhLyc+CjxyZGY6UkRGIHhtbG5zOnJkZj0naHR0cDovL3d3dy53My5vcmcvMTk5OS8wMi8yMi1yZGYtc3ludGF4LW5zIyc+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpBdHRyaWI9J2h0dHA6Ly9ucy5hdHRyaWJ1dGlvbi5jb20vYWRzLzEuMC8nPgogIDxBdHRyaWI6QWRzPgogICA8cmRmOlNlcT4KICAgIDxyZGY6bGkgcmRmOnBhcnNlVHlwZT0nUmVzb3VyY2UnPgogICAgIDxBdHRyaWI6Q3JlYXRlZD4yMDI1LTAzLTA1PC9BdHRyaWI6Q3JlYXRlZD4KICAgICA8QXR0cmliOkV4dElkPjIwNzFhOGUyLTRlOTUtNDFlYi1hY2RlLTE1OTg3NWE1ZjJlYzwvQXR0cmliOkV4dElkPgogICAgIDxBdHRyaWI6RmJJZD41MjUyNjU5MTQxNzk1ODA8L0F0dHJpYjpGYklkPgogICAgIDxBdHRyaWI6VG91Y2hUeXBlPjI8L0F0dHJpYjpUb3VjaFR5cGU+CiAgICA8L3JkZjpsaT4KICAgPC9yZGY6U2VxPgogIDwvQXR0cmliOkFkcz4KIDwvcmRmOkRlc2NyaXB0aW9uPgoKIDxyZGY6RGVzY3JpcHRpb24gcmRmOmFib3V0PScnCiAgeG1sbnM6ZGM9J2h0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvJz4KICA8ZGM6dGl0bGU+CiAgIDxyZGY6QWx0PgogICAgPHJkZjpsaSB4bWw6bGFuZz0neC1kZWZhdWx0Jz5VbnRpdGxlZCBkZXNpZ24gLSAxPC9yZGY6bGk+CiAgIDwvcmRmOkFsdD4KICA8L2RjOnRpdGxlPgogPC9yZGY6RGVzY3JpcHRpb24+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczpwZGY9J2h0dHA6Ly9ucy5hZG9iZS5jb20vcGRmLzEuMy8nPgogIDxwZGY6QXV0aG9yPk1pa2EgTmFuPC9wZGY6QXV0aG9yPgogPC9yZGY6RGVzY3JpcHRpb24+CgogPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9JycKICB4bWxuczp4bXA9J2h0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8nPgogIDx4bXA6Q3JlYXRvclRvb2w+Q2FudmEgZG9jPURBR2dsa2ZMZ0w4IHVzZXI9VUFGek8wb0dVcEkgYnJhbmQ9QkFGek82Y0tfNTQgdGVtcGxhdGU9PC94bXA6Q3JlYXRvclRvb2w+CiA8L3JkZjpEZXNjcmlwdGlvbj4KPC9yZGY6UkRGPgo8L3g6eG1wbWV0YT4KPD94cGFja2V0IGVuZD0ncic/PlgaFwUAABJdSURBVHic7Z0HrBbFFsc3L3kvCgIWQAXsBUVAr1gAGxqUa8UuGhEVBWLvsSDYEOwFCypWLBBQL6JwbXCfiCgiAjbs0gQ7iOIz7yXz9r+wZO93Z7bN7ncWvv8/+SUK7O7Z3fPNzpw5c8Zx0qm5S3+XiS5zXBa4rHBRhMQAvgKfge/Ah/o5q3wqVzVx6eNS6/LfMt0oqRzgU5Ncers0djJWN5fpBbhJUhnA1zo7GajKZUoBbohUJhOcVT6YSq1cZhXgJkhlM9OltZNQ8PrFBTCeELDIpZ0TUy2cVSNEaaMJCTLfpaUToX+6TC2AsYTo+LfLP5wQjSiAkYSEMcwxCH2M/xXAQELCgI92cDSqLYBxhMQBvlpP1QUwipAkdHMCYutL1jZqnNVq6vJ3AQwiJAnLXP7l4vQqgDGEpAFdX2dkAQwhJA0I+7L/S9ZavGjE7AIYQkga4LteZ1jaEELSsNQpgBGEpOU/TgGMIMQGcQMIsUHcAEJsEDeAEBvEDSDEBnEDCLFB3ABCbBA3gBAbxA0gxAZxAwixQdwAQmwQN4AQG8QNIMQGcQMIsUHcAEJsEDeAEBvEDSDEBnEDCLFB3ABCbBA3gBAbxA0gxAZxA0iB2W233dQBBxzgsd9++6mdd95ZbbLJJuJ2BRA3gBSAtm3bqhNPPFFdd911asyYMWrOnDkqSu+995667777vGMFbZd/eKT8tG/fXl122WWqpqZG/fzzz5HOGqWrrrpK6l7kHybJn8aNG6sjjzxSPfDAA2rBggWRDvnnn3+qqVOnqlGjRqmhQ4eqwYMHr+Gmm27yWukffvih3jG33HKLxL3JP1ySDzvttJMaOHCgevvttyMd9q233lJ33nmn6t27t+rYsWPsaxx//PFq5syZa85zxBFHlPs+5R80yQ70R6+//nr10UcfhTrsO++8o4YNG6YOOeQQtf7661tf95prrvHOO3HixHLfs/xDJ3age9C3b1/vk2/S999/r4YPH66qq6vVeuutl4sdo0ePVosWLSr3/cu/AJKO/fffXz3++ONef1Un9FFvu+02tccee5TFnq5du6qffvqp3M9B/kWQ+Gy11VZeFyFsIPbss8+q7t27l922Fi1aqBkzZpT7uvIvhURz4IEHqvHjxxud9ptvvlGXX36550RSNlZVValBgwaV+7ryL4foQV91wIABat68eUbHRZgLzi1tKzj33HPVpptuWu7ryt84qc8222yj7rjjDrV8+XKt08Khzz//fNW0aVNxW4P06NFD4rryN05WgVyDV155xdjaogsh0bcNss8++6hOnTo1+PNmzZpJ2ST/4iqdww8/3DjZsHLlSi/8tfXWW4vaeNFFF6nPP/+8nm1nnnmm2n333aWfn/wLrFSOO+44NXv2bK3jIj8B07bNmzcXtxOzeUH98ccfqra2Vi1btkzdfffd0vbJv8hKA5MOX375pdZxEbu95JJLcptsSMqee+5p7NJg+hlplhdccIGkjfIPqVLo37+/N1O1NjiuD5J/dMIP8IYbblALFy5UG220kaSN8g9pXeekk04ytrhLlixRF198ceEc1wfplqWC03766adqxYoVXgt98803e5ETIRvlH9K6ysEHH6xmzZqlddxvv/3Wa5GlbYziwQcfrGf3b7/95vWBoVNOOUVNmTLF++9GjRpJ2Sj/kPKkTZs26uijj/ZWGtx7771e4H/ChAnqzTffVGPHjlUjR470Yq4YqCBfNovRPmakXn31Va3jfvHFF17KYprzbrnllurYY4/18m5xfjgPwH9j+vj+++/3cnWR4oj7zuL5IUKiExz7xx9/9P4bAzrBdyzvZFmy2WabqbPOOku98MILqVca4NM4efJkdfrppyf6tG+//fbqueee054TSS6YqUp6Pzjnww8/7HU1kmrx4sXqscce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";
            
            // Create the new header structure with logo
            const newHeaderHTML = `
                <div class="logo-container">
                    <img src="${logoBase64}" alt="GSI Logo" class="app-logo">
                </div>
                <h1 class="app-title">·Éì·Éù·É£·Éë·Éê·Éú·Éî·Éö·Éò·Éñ·Éê·É¢·Éù·É†·Éò ·É°·Éê·É°·Éô·Éù·Éö·Éù ·É†·Éê·Éñ·Éï·Éî·Éì·Éô·Éê</h1>
                <div class="header-actions">
                    <label for="file-upload" class="upload-btn">
                        <span>·Éê·É¢·Éï·Éò·É†·Éó·Éî·Éó CSV</span>
                        <input id="file-upload" type="file" accept=".csv" class="hidden" />
                    </label>
                </div>
            `;
            
            // Update the header content
            headerContent.innerHTML = newHeaderHTML;
            
            // Add appropriate styles
            addLogoStyles();
            
            console.log("Header updated with logo");
        }

        // Add CSS styles for the logo and updated header
        function addLogoStyles() {
            // Create a style element if it doesn't exist
            let styleElement = document.getElementById('logo-styles');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'logo-styles';
                document.head.appendChild(styleElement);
            }
            
            // Add the necessary CSS
            styleElement.textContent = `
                .header-content {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    flex-wrap: wrap;
                    gap: 1rem;
                }
                
                .logo-container {
                    display: flex;
                    align-items: center;
                }
                
                .app-logo {
                    height: 60px;
                    width: 60px;
                    border-radius: 8px;
                    margin-right: 1rem;
                    object-fit: cover;
                }
                
                .app-title {
                    font-size: 1.5rem;
                    font-weight: bold;
                    margin: 0;
                    flex-grow: 1;
                }
                
                .header-actions {
                    display: flex;
                    align-items: center;
                }
                
                @media (max-width: 768px) {
                    .header-content {
                        flex-direction: column;
                        align-items: center;
                        text-align: center;
                    }
                    
                    .app-logo {
                        margin-right: 0;
                        margin-bottom: 0.5rem;
                    }
                    
                    .app-title {
                        margin-bottom: 1rem;
                    }
                }
            `;
        }

        // Call this function after the page loads to update the header
        document.addEventListener('DOMContentLoaded', function() {
            updateHeaderWithLogo();
            
            // Re-attach the file upload event handler if needed
            document.getElementById('file-upload').addEventListener('change', handleFileUpload);
        });

        function setupEventListeners() {
            try {
                // File upload handling
                document.getElementById('file-upload').addEventListener('change', handleFileUpload);
                document.getElementById('upload-btn').addEventListener('click', function() {
                    document.getElementById('file-upload').click();
                });
                
                // Reset filters button
                document.getElementById('reset-filters').addEventListener('click', resetFilters);
                
                // Pagination
                document.getElementById('prev-page').addEventListener('click', function() {
                    if (currentPage > 1) {
                        currentPage--;
                        updateTable();
                    }
                });
                
                document.getElementById('next-page').addEventListener('click', function() {
                    const totalPages = Math.ceil(filteredData.length / rowsPerPage);
                    if (currentPage < totalPages) {
                        currentPage++;
                        updateTable();
                    }
                });
                
                // Export button
                document.getElementById('export-csv').addEventListener('click', exportFilteredData);
                
                // Initial setup for filters
                setupSearchFilter();
                
                // Facilities filter
                document.querySelectorAll('.facility-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', applyFilters);
                });
                
                console.log("Event listeners set up successfully");
            } catch (error) {
                console.error("Error setting up event listeners:", error);
                alert("·Éê·Éû·Éö·Éò·Éô·Éê·É™·Éò·Éò·É° ·Éò·Éú·Éò·É™·Éò·Éê·Éö·Éò·Éñ·Éê·É™·Éò·Éò·É°·Éê·É° ·Éõ·Éù·ÉÆ·Éì·Éê ·É®·Éî·É™·Éì·Éù·Éõ·Éê. ·Éí·Éó·ÉÆ·Éù·Éï·Éó, ·Éí·Éê·Éú·Éê·Éê·ÉÆ·Éö·Éù·Éó ·Éí·Éï·Éî·É†·Éì·Éò ·Éì·Éê ·É°·É™·Éê·Éì·Éù·Éó ·Éó·Éê·Éï·Éò·Éì·Éê·Éú.");
            }
        }
        
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Show loading indicator
            document.getElementById('loading').style.display = 'flex';
            
            try {
                // Read the CSV file
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: true,
                    encoding: "UTF-8",
                    complete: function(results) {
                        try {
                            console.log("CSV parsed successfully, rows:", results.data.length);
                            
                            // Process the data
                            processData(results.data);
                            
                            // Hide welcome screen, show data explorer
                            document.getElementById('welcome-screen').classList.add('hidden');
                            document.getElementById('data-explorer').classList.remove('hidden');
                        } catch (error) {
                            console.error('Error processing data:', error);
                            alert('·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° ·Éì·Éê·Éõ·É£·É®·Éê·Éï·Éî·Éë·Éò·É°·Éê·É° ·Éõ·Éù·ÉÆ·Éì·Éê ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + error.message);
                        } finally {
                            // Hide loading indicator
                            document.getElementById('loading').style.display = 'none';
                        }
                    },
                    error: function(error) {
                        console.error('Error parsing CSV:', error);
                        alert('CSV ·É§·Éê·Éò·Éö·Éò·É° ·Éì·Éê·Éõ·É£·É®·Éê·Éï·Éî·Éë·Éò·É°·Éê·É° ·Éõ·Éù·ÉÆ·Éì·Éê ·É®·Éî·É™·Éì·Éù·Éõ·Éê. ·Éí·Éó·ÉÆ·Éù·Éï·Éó, ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éù·Éó ·É§·Éê·Éò·Éö·Éò·É° ·É§·Éù·É†·Éõ·Éê·É¢·Éò ·Éì·Éê ·É°·É™·Éê·Éì·Éù·Éó ·Éó·Éê·Éï·Éò·Éì·Éê·Éú.');
                        document.getElementById('loading').style.display = 'none';
                    }
                });
            } catch (error) {
                console.error('Error initializing CSV parsing:', error);
                alert('CSV ·Éì·Éê·Éõ·É£·É®·Éê·Éï·Éî·Éë·Éò·É° ·Éò·Éú·Éò·É™·Éò·Éê·Éö·Éò·Éñ·Éê·É™·Éò·Éò·É°·Éê·É° ·Éõ·Éù·ÉÆ·Éì·Éê ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        function addFacilityToggleStyles() {
            // Create a style element if it doesn't exist
            let styleElement = document.getElementById('facility-toggle-styles');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'facility-toggle-styles';
                document.head.appendChild(styleElement);
            }
            
            // Add the necessary CSS
            styleElement.textContent = `
                .facility-toggle-container {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 0.75rem;
                    margin-top: 0.75rem;
                }
                
                .facility-toggle {
                    position: relative;
                    cursor: pointer;
                    background-color: var(--color-gray-light);
                    border-radius: 4px;
                    padding: 0.5rem 1rem;
                    transition: all 0.3s ease;
                    text-align: center;
                    border: 1px solid var(--color-gray);
                    font-size: 0.875rem;
                    height: 64px;
                    display: flex;
                    flex-direction: column;
                    justify-content: center;
                    align-items: center;
                    user-select: none;
                }
                
                .facility-toggle .icon {
                    font-size: 1.2rem;
                    margin-bottom: 0.25rem;
                }
                
                .facility-toggle .status {
                    font-size: 0.75rem;
                    font-weight: 500;
                    margin-top: 0.25rem;
                    padding: 2px 8px;
                    border-radius: 10px;
                    background: var(--color-gray);
                    color: var(--color-white);
                }
                
                /* State: All */
                .facility-toggle[data-state="all"] {
                    background-color: var(--color-gray-light);
                    border-color: var(--color-gray);
                }
                .facility-toggle[data-state="all"] .status {
                    background: var(--color-gray-dark);
                }
                
                /* State: Yes */
                .facility-toggle[data-state="yes"] {
                    background-color: rgba(80, 200, 120, 0.1);
                    border-color: rgb(80, 200, 120);
                }
                .facility-toggle[data-state="yes"] .status {
                    background: rgb(80, 200, 120);
                }
                
                /* State: No */
                .facility-toggle[data-state="no"] {
                    background-color: rgba(240, 100, 100, 0.1);
                    border-color: rgb(240, 100, 100);
                }
                .facility-toggle[data-state="no"] .status {
                    background: rgb(240, 100, 100);
                }
            `;
        }

        // Function to set up facilities filter with toggle buttons
        function setupFacilitiesFilter() {
            const facilitiesFilter = document.getElementById('facilities-filter');
            facilitiesFilter.classList.remove('hidden');
            
            // Define facility items with icons and labels
            const facilities = [
                { id: 'lab', field: '·Éö·Éê·Éë·Éù·É†·Éê·É¢·Éù·É†·Éò·Éê', label: '·Éö·Éê·Éë·Éù·É†·Éê·É¢·Éù·É†·Éò·Éê', icon: 'üß™' },
                { id: 'computers', field: '·Éô·Éù·Éõ·Éû·Éò·É£·É¢·Éî·É†·Éî·Éë·Éò', label: '·Éô·Éù·Éõ·Éû·Éò·É£·É¢·Éî·É†·Éî·Éë·Éò', icon: 'üíª' },
                { id: 'projector', field: '·Éû·É†·Éù·Éî·É•·É¢·Éù·É†·Éò', label: '·Éû·É†·Éù·Éî·É•·É¢·Éù·É†·Éò', icon: 'üìΩÔ∏è' },
                { id: 'internet', field: '·É¨·Éï·Éì·Éù·Éõ·Éê ·Éò·Éú·É¢·Éî·É†·Éú·Éî·É¢·Éó·Éê·Éú', label: '·Éò·Éú·É¢·Éî·É†·Éú·Éî·É¢·Éò', icon: 'üåê' }
            ];
            
            // Create the toggle container
            const container = document.createElement('div');
            container.className = 'facility-toggle-container';
            
            // Create toggle buttons for each facility
            facilities.forEach(facility => {
                const toggle = document.createElement('div');
                toggle.className = 'facility-toggle';
                toggle.id = `${facility.id}-toggle`;
                toggle.setAttribute('data-state', 'all');
                toggle.setAttribute('data-field', facility.field);
                toggle.innerHTML = `
                    <div class="icon">${facility.icon}</div>
                    <div class="label">${facility.label}</div>
                    <div class="status">·Éß·Éï·Éî·Éö·Éê</div>
                `;
                
                // Add click event to cycle through states
                toggle.addEventListener('click', function() {
                    const currentState = this.getAttribute('data-state');
                    let newState;
                    
                    if (currentState === 'all') {
                        newState = 'yes';
                        this.setAttribute('data-state', 'yes');
                        this.querySelector('.status').textContent = '·Éô·Éò';
                    } else if (currentState === 'yes') {
                        newState = 'no';
                        this.setAttribute('data-state', 'no');
                        this.querySelector('.status').textContent = '·Éê·É†·Éê';
                    } else {
                        newState = 'all';
                        this.setAttribute('data-state', 'all');
                        this.querySelector('.status').textContent = '·Éß·Éï·Éî·Éö·Éê';
                    }
                    
                    applyFilters();
                });
                
                container.appendChild(toggle);
            });
            
            // Replace existing facility filter content
            facilitiesFilter.innerHTML = '<label class="filter-label">·É°·Éê·É°·Éô·Éù·Éö·Éù ·Éò·Éú·É§·É†·Éê·É°·É¢·É†·É£·É•·É¢·É£·É†·Éê</label>';
            facilitiesFilter.appendChild(container);
        }

        // Add necessary CSS styles for the dual range slider
        function addRangeSliderStyles() {
            // Create a style element if it doesn't exist
            let styleElement = document.getElementById('custom-range-slider-styles');
            if (!styleElement) {
                styleElement = document.createElement('style');
                styleElement.id = 'custom-range-slider-styles';
                document.head.appendChild(styleElement);
            }
            
            // Add the necessary CSS
            styleElement.textContent = `
                .range-container {
                    position: relative;
                    width: 100%;
                    height: 40px;
                    margin: 10px 0 25px 0;
                }
                .slider-track {
                    position: absolute;
                    top: 17px;
                    width: 100%;
                    height: 6px;
                    background: var(--color-gray);
                    border-radius: 3px;
                }
                .slider-range {
                    position: absolute;
                    top: 17px;
                    height: 6px;
                    background: var(--color-ocean-blue-light);
                    border-radius: 3px;
                }
                .range-input {
                    position: relative;
                    width: 100%;
                }
                .range-input input {
                    position: absolute;
                    width: 100%;
                    height: 6px;
                    top: 0;
                    background: none;
                    pointer-events: none;
                    -webkit-appearance: none;
                    -moz-appearance: none;
                    appearance: none;
                }
                .range-input input::-webkit-slider-thumb {
                    height: 18px;
                    width: 18px;
                    border-radius: 50%;
                    background: var(--color-ocean-blue);
                    pointer-events: auto;
                    -webkit-appearance: none;
                    cursor: pointer;
                    border: 2px solid var(--color-white);
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                    z-index: 10;
                }
                .range-input input::-moz-range-thumb {
                    height: 18px;
                    width: 18px;
                    border-radius: 50%;
                    background: var(--color-ocean-blue);
                    pointer-events: auto;
                    -moz-appearance: none;
                    cursor: pointer;
                    border: 2px solid var(--color-white);
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                    z-index: 10;
                }
                .range-input input.min-range::-webkit-slider-thumb {
                    background: var(--color-ocean-blue);
                }
                .range-input input.max-range::-webkit-slider-thumb {
                    background: var(--color-ocean-blue-dark);
                }
                .range-input input.min-range::-moz-range-thumb {
                    background: var(--color-ocean-blue);
                }
                .range-input input.max-range::-moz-range-thumb {
                    background: var(--color-ocean-blue-dark);
                }
            `;
        }
        
        function processData(data) {
            console.log('Processing data:', data.length, 'rows');
            
            // Store the original data
            originalData = data;
            
            // Initial filtering (just a copy at first)
            filteredData = [...originalData];
            
            // Setup table columns and data
            setupTable();
            
            // Setup filters
            setupFilters();
            
            // Update summary stats
            updateSummaryStats();
        }
        
        function setupTable() {
            if (originalData.length === 0) return;
            
            // Get important columns
            const columns = [
                '·É°·Éô·Éù·Éö·Éò·É° ·Éì·Éê·É°·Éê·ÉÆ·Éî·Éö·Éî·Éë·Éê',
                '·É†·Éî·Éí·Éò·Éù·Éú·Éò',
                '·É†·Éê·Éò·Éù·Éú·Éò',
                '·É°·Éô·Éù·Éö·Éò·É° ·É¢·Éò·Éû·Éò',
                '·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê',
                '·Éë·Éò·É£·ÉØ·Éî·É¢·Éò_·Éö·Éê·É†·Éò',
                '·ÉÆ·Éê·É†·ÉØ·Éî·Éë·Éò_·Éî·É†·Éó_·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éñ·Éî'
            ];
            
            // Set up table header
            const headerRow = document.getElementById('table-header');
            headerRow.innerHTML = '';
            
            columns.forEach(column => {
                const th = document.createElement('th');
                th.textContent = column;
                th.addEventListener('click', () => sortTable(column));
                headerRow.appendChild(th);
            });
            
            // Initial table population
            updateTable();
        }
        
        function updateTable() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';
            
            if (filteredData.length === 0) {
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="7" style="text-align:center; padding:2rem;">
                        ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éê·É† ·Éõ·Éù·Éò·É´·Éî·Éë·Éú·Éê
                    </td>
                `;
                tableBody.appendChild(emptyRow);
                
                // Update pagination info
                document.getElementById('showing-entries').textContent = '·Éú·Éê·É©·Éï·Éî·Éú·Éî·Éë·Éò·Éê 0 ·É©·Éê·Éú·Éê·É¨·Éî·É†·Éò';
                document.getElementById('page-indicator').textContent = '·Éí·Éï·Éî·É†·Éì·Éò 0/0';
                document.getElementById('prev-page').disabled = true;
                document.getElementById('next-page').disabled = true;
                
                return;
            }
            
            // Calculate pagination
            const totalPages = Math.ceil(filteredData.length / rowsPerPage);
            const startIndex = (currentPage - 1) * rowsPerPage;
            const endIndex = Math.min(startIndex + rowsPerPage, filteredData.length);
            
            // Update pagination info
            document.getElementById('showing-entries').textContent = `·Éú·Éê·É©·Éï·Éî·Éú·Éî·Éë·Éò·Éê ${startIndex + 1}-${endIndex} (${filteredData.length}-·Éì·Éê·Éú)`;
            document.getElementById('page-indicator').textContent = `·Éí·Éï·Éî·É†·Éì·Éò ${currentPage}/${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages;
            
            // Add rows for current page
            const pageData = filteredData.slice(startIndex, endIndex);
            
            pageData.forEach((row, rowIndex) => {
                const tableRow = document.createElement('tr');
                
                // Add cells for our selected columns
                [
                    '·É°·Éô·Éù·Éö·Éò·É° ·Éì·Éê·É°·Éê·ÉÆ·Éî·Éö·Éî·Éë·Éê',
                    '·É†·Éî·Éí·Éò·Éù·Éú·Éò',
                    '·É†·Éê·Éò·Éù·Éú·Éò',
                    '·É°·Éô·Éù·Éö·Éò·É° ·É¢·Éò·Éû·Éò',
                    '·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê',
                    '·Éë·Éò·É£·ÉØ·Éî·É¢·Éò_·Éö·Éê·É†·Éò',
                    '·ÉÆ·Éê·É†·ÉØ·Éî·Éë·Éò_·Éî·É†·Éó_·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éñ·Éî'
                ].forEach(column => {
                    const td = document.createElement('td');
                    
                    // Format values appropriately
                    let value = row[column];
                    
                    // Handle numeric columns with formatting
                    if (['·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê', '·Éë·Éò·É£·ÉØ·Éî·É¢·Éò_·Éö·Éê·É†·Éò', '·ÉÆ·Éê·É†·ÉØ·Éî·Éë·Éò_·Éî·É†·Éó_·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éñ·Éî'].includes(column)) {
                        td.classList.add('text-right');
                        if (typeof value === 'number') {
                            td.textContent = value.toLocaleString();
                        } else {
                            td.textContent = value || '';
                        }
                    } else {
                        td.textContent = value || '';
                    }
                    
                    tableRow.appendChild(td);
                });
                
                tableBody.appendChild(tableRow);
            });
        }
        
        function sortTable(column) {
            // Sort the data
            filteredData.sort((a, b) => {
                let valueA = a[column];
                let valueB = b[column];
                
                // Handle null/undefined values
                if (valueA === null || valueA === undefined) valueA = '';
                if (valueB === null || valueB === undefined) valueB = '';
                
                // Handle numeric sorting
                if (['·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê', '·Éë·Éò·É£·ÉØ·Éî·É¢·Éò_·Éö·Éê·É†·Éò', '·ÉÆ·Éê·É†·ÉØ·Éî·Éë·Éò_·Éî·É†·Éó_·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éñ·Éî'].includes(column)) {
                    valueA = parseFloat(valueA) || 0;
                    valueB = parseFloat(valueB) || 0;
                    return valueA - valueB;
                }
                
                // Handle string sorting
                if (typeof valueA === 'string' && typeof valueB === 'string') {
                    return valueA.localeCompare(valueB);
                }
                
                // Fallback comparison
                return valueA < valueB ? -1 : valueA > valueB ? 1 : 0;
            });
            
            // Reset to first page and update the table
            currentPage = 1;
            updateTable();
        }
        
        // This function fixes the student range slider setup to properly handle maximum values
        function setupStudentFilter(originalData) {
            try {
                // Extract student values with improved handling
                const studentValues = originalData
                    .map(row => {
                        let value = row['·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê'];
                        // Handle string values with commas
                        if (typeof value === 'string') {
                            value = value.replace(/,/g, '');
                        }
                        return parseInt(value);
                    })
                    .filter(val => !isNaN(val) && val !== null);
                
                if (studentValues.length > 0) {
                    // Find min and max values
                    const minStudents = Math.min(...studentValues);
                    
                    // For the max value, ensure we round up to the next step to include all values
                    const rawMaxStudents = Math.max(...studentValues);
                    const step = 10;
                    // Round up to the next step multiple to ensure inclusion of all values
                    const maxStudents = Math.ceil(rawMaxStudents / step) * step;
                    
                    console.log(`Student range: Raw min=${minStudents}, Raw max=${rawMaxStudents}, Adjusted max=${maxStudents}`);
                    
                    const studentsFilter = document.getElementById('students-filter');
                    studentsFilter.classList.remove('hidden');
                    
                    // Update HTML structure for the range slider
                    studentsFilter.innerHTML = `
                        <label class="filter-label">·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê</label>
                        <div class="range-labels">
                            <span>·Éõ·Éò·Éú: <span id="students-min-display">${minStudents.toLocaleString()}</span></span>
                            <span>·Éõ·Éê·É•·É°: <span id="students-max-display">${maxStudents.toLocaleString()}</span></span>
                        </div>
                        <div class="range-container">
                            <div class="slider-track"></div>
                            <div class="slider-range" id="students-range"></div>
                            <div class="range-input">
                                <input type="range" class="min-range" id="students-min-slider" 
                                    min="${minStudents}" max="${maxStudents}" value="${minStudents}" step="${step}">
                                <input type="range" class="max-range" id="students-max-slider" 
                                    min="${minStudents}" max="${maxStudents}" value="${maxStudents}" step="${step}">
                            </div>
                        </div>
                    `;
                    
                    // Add event listeners for students range slider
                    setupRangeSlider('students', minStudents, maxStudents);
                    
                    console.log("Students filter set up with range:", minStudents, "to", maxStudents);
                }
            } catch (error) {
                console.error("Error setting up student filter:", error);
            }
        }

        // Updated setupFilters function to use the specialized student filter setup
        function setupFilters() {
            try {
                if (originalData.length === 0) return;
                
                console.log("Setting up filters...");
                
                // Add the necessary CSS styles for range sliders and facility toggles
                addRangeSliderStyles();
                addFacilityToggleStyles();
                
                // Setup budget filter with min/max range slider
                const budgetValues = originalData
                    .map(row => {
                        let value = row['·Éë·Éò·É£·ÉØ·Éî·É¢·Éò_·Éö·Éê·É†·Éò'];
                        // Handle string values with commas
                        if (typeof value === 'string') {
                            value = value.replace(/,/g, '');
                        }
                        return parseFloat(value);
                    })
                    .filter(val => !isNaN(val) && val !== null);
                
                if (budgetValues.length > 0) {
                    // For the budget, also round up to next step to ensure inclusion
                    const minBudget = Math.min(...budgetValues);
                    const rawMaxBudget = Math.max(...budgetValues);
                    const step = 1000;
                    const maxBudget = Math.ceil(rawMaxBudget / step) * step;
                    
                    const budgetFilter = document.getElementById('budget-filter');
                    budgetFilter.classList.remove('hidden');
                    
                    // Update HTML structure for the range slider
                    budgetFilter.innerHTML = `
                        <label class="filter-label">·Éë·Éò·É£·ÉØ·Éî·É¢·Éò</label>
                        <div class="range-labels">
                            <span>·Éõ·Éò·Éú: <span id="budget-min-display">${minBudget.toLocaleString()}</span></span>
                            <span>·Éõ·Éê·É•·É°: <span id="budget-max-display">${maxBudget.toLocaleString()}</span></span>
                        </div>
                        <div class="range-container">
                            <div class="slider-track"></div>
                            <div class="slider-range" id="budget-range"></div>
                            <div class="range-input">
                                <input type="range" class="min-range" id="budget-min-slider" 
                                    min="${minBudget}" max="${maxBudget}" value="${minBudget}" step="${step}">
                                <input type="range" class="max-range" id="budget-max-slider" 
                                    min="${minBudget}" max="${maxBudget}" value="${maxBudget}" step="${step}">
                            </div>
                        </div>
                    `;
                    
                    // Add event listeners for budget range slider
                    setupRangeSlider('budget', minBudget, maxBudget);
                    
                    console.log("Budget filter set up with range:", minBudget, "to", maxBudget);
                }
                
                // Setup students filter using the dedicated function
                setupStudentFilter(originalData);
                
                // Setup grade distribution visualization with initial data
                setupGradeDistribution(originalData);
                
                // Setup region filter with improved ID generation and null handling
                const regions = [...new Set(originalData
                    .map(row => row['·É†·Éî·Éí·Éò·Éù·Éú·Éò'])
                    .filter(val => val && val.trim() !== '') // Remove null and empty values
                )];
                
                if (regions.length > 0) {
                    const regionFilter = document.getElementById('region-filter');
                    const regionOptions = document.getElementById('region-options');
                    
                    regionFilter.classList.remove('hidden');
                    regionOptions.innerHTML = '';
                    
                    // Add "Unknown/Empty" option to explicitly handle null/empty values
                    const unknownDiv = document.createElement('div');
                    unknownDiv.className = 'checkbox-item';
                    unknownDiv.innerHTML = `
                        <input type="checkbox" id="region-unknown" 
                            class="region-checkbox" 
                            value="__unknown__">
                        <label for="region-unknown" class="checkbox-label">·É£·É™·Éú·Éù·Éë·Éò/·É™·Éê·É†·Éò·Éî·Éö·Éò</label>
                    `;
                    regionOptions.appendChild(unknownDiv);
                    unknownDiv.querySelector('input[type="checkbox"]').addEventListener('change', applyFilters);
                    
                    // Add all other regions
                    regions.forEach(region => {
                        const div = document.createElement('div');
                        div.className = 'checkbox-item';
                        
                        // Create safe ID by replacing spaces and special characters
                        const safeId = 'region-' + region.toString()
                            .replace(/\s+/g, '_')
                            .replace(/[^\w\-]/g, '');
                        
                        div.innerHTML = `
                            <input type="checkbox" id="${safeId}" 
                                class="region-checkbox" 
                                value="${region}">
                            <label for="${safeId}" class="checkbox-label">${region}</label>
                        `;
                        regionOptions.appendChild(div);
                        
                        // Add event listener
                        div.querySelector('input[type="checkbox"]').addEventListener('change', applyFilters);
                    });
                    
                    console.log("Region filter set up with", regions.length, "regions plus unknown option");
                }
                
                // Setup school type filter
                const types = [...new Set(originalData
                    .map(row => row['·É°·Éô·Éù·Éö·Éò·É° ·É¢·Éò·Éû·Éò'])
                    .filter(val => val)
                )];
                
                if (types.length > 0) {
                    const typeFilter = document.getElementById('type-filter');
                    const typeOptions = document.getElementById('type-options');
                    
                    typeFilter.classList.remove('hidden');
                    typeOptions.innerHTML = '';
                    
                    types.forEach(type => {
                        const div = document.createElement('div');
                        div.className = 'checkbox-item';
                        
                        // Create safe ID by replacing spaces and special characters
                        const safeId = 'type-' + type.toString()
                            .replace(/\s+/g, '_')
                            .replace(/[^\w\-]/g, '');
                        
                        div.innerHTML = `
                            <input type="checkbox" id="${safeId}" 
                                class="type-checkbox" 
                                value="${type}">
                            <label for="${safeId}" class="checkbox-label">${type}</label>
                        `;
                        typeOptions.appendChild(div);
                        
                        // Add event listener
                        div.querySelector('input[type="checkbox"]').addEventListener('change', applyFilters);
                    });
                    
                    console.log("School type filter set up with", types.length, "types");
                }
                
                // Setup improved facilities filter
                setupFacilitiesFilter();
                
            } catch (error) {
                console.error("Error setting up filters:", error);
            }
        }

        function setupRangeSlider(prefix, minValue, maxValue) {
            try {
                const minSlider = document.getElementById(`${prefix}-min-slider`);
                const maxSlider = document.getElementById(`${prefix}-max-slider`);
                const minDisplay = document.getElementById(`${prefix}-min-display`);
                const maxDisplay = document.getElementById(`${prefix}-max-display`);
                const range = document.getElementById(`${prefix}-range`);
                
                // Initial range position
                const percent1 = ((minSlider.value - minSlider.min) / (minSlider.max - minSlider.min)) * 100;
                const percent2 = ((maxSlider.value - maxSlider.min) / (maxSlider.max - maxSlider.min)) * 100;
                range.style.left = percent1 + '%';
                range.style.width = (percent2 - percent1) + '%';
                
                function updateRange() {
                    const percent1 = ((minSlider.value - minSlider.min) / (minSlider.max - minSlider.min)) * 100;
                    const percent2 = ((maxSlider.value - maxSlider.min) / (maxSlider.max - maxSlider.min)) * 100;
                    range.style.left = percent1 + '%';
                    range.style.width = (percent2 - percent1) + '%';
                }
                
                minSlider.addEventListener('input', function() {
                    // Prevent min from exceeding max
                    if (parseInt(minSlider.value) > parseInt(maxSlider.value)) {
                        minSlider.value = maxSlider.value;
                    }
                    
                    // Format and display the value
                    const formattedValue = parseInt(minSlider.value).toLocaleString();
                    minDisplay.textContent = formattedValue;
                    
                    // Update the colored range
                    updateRange();
                    
                    // Apply filters
                    applyFilters();
                });
                
                maxSlider.addEventListener('input', function() {
                    // Prevent max from going below min
                    if (parseInt(maxSlider.value) < parseInt(minSlider.value)) {
                        maxSlider.value = minSlider.value;
                    }
                    
                    // Format and display the value
                    const formattedValue = parseInt(maxSlider.value).toLocaleString();
                    maxDisplay.textContent = formattedValue;
                    
                    // Update the colored range
                    updateRange();
                    
                    // Apply filters
                    applyFilters();
                });
            } catch (error) {
                console.error(`Error setting up ${prefix} range slider:`, error);
            }
        }

        // Updated setupGradeDistribution to work with filtered data
        function setupGradeDistribution(dataToUse) {
            // Grade columns from I to XII
            const gradeColumns = ['I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X', 'XI', 'XII'];
            
            // Check if we have grade data
            const hasGradeData = dataToUse.some(row => {
                return gradeColumns.some(col => row[col] !== undefined && row[col] !== null);
            });
            
            if (!hasGradeData) {
                return;
            }
            
            // Show the grade filter
            const gradeFilter = document.getElementById('grade-filter');
            gradeFilter.classList.remove('hidden');
            
            // Get the distribution container
            const distributionContainer = document.getElementById('grade-distribution');
            distributionContainer.innerHTML = '';
            
            // Calculate averages for each grade
            let gradeAverages = {};
            let maxAverage = 0;
            
            gradeColumns.forEach(grade => {
                const values = dataToUse
                    .map(row => parseFloat(row[grade]))
                    .filter(val => !isNaN(val) && val !== null);
                
                if (values.length > 0) {
                    const average = values.reduce((a, b) => a + b, 0) / values.length;
                    gradeAverages[grade] = average;
                    if (average > maxAverage) maxAverage = average;
                } else {
                    gradeAverages[grade] = 0;
                }
            });
            
            // Create bars for each grade
            gradeColumns.forEach(grade => {
                const barHeight = maxAverage > 0 ? (gradeAverages[grade] / maxAverage) * 100 : 0;
                const scaledHeight = 10 + (barHeight * 0.8); // Scale to have minimum height
                
                const bar = document.createElement('div');
                bar.className = 'grade-bar';
                bar.style.height = `${scaledHeight}px`;
                bar.setAttribute('data-grade', grade);
                bar.innerHTML = `
                    <span class="grade-bar-label">${grade}</span>
                    <span class="grade-bar-value">${Math.round(gradeAverages[grade])}</span>
                `;
                
                distributionContainer.appendChild(bar);
            });
        }

        function setupSearchFilter() {
            // Set up search filter
            const nameSearch = document.getElementById('name-search');
            nameSearch.addEventListener('input', applyFilters);
        }
        
        // Fixed facility filtering logic
        function applyFilters() {
            try {
                // Start with all data
                filteredData = [...originalData];
                
                // Apply budget filter with min and max values
                const budgetMinSlider = document.getElementById('budget-min-slider');
                const budgetMaxSlider = document.getElementById('budget-max-slider');
                
                if (budgetMinSlider && budgetMaxSlider && 
                    !budgetMinSlider.parentElement.parentElement.parentElement.classList.contains('hidden')) {
                    
                    const minBudget = parseFloat(budgetMinSlider.value);
                    const maxBudget = parseFloat(budgetMaxSlider.value);
                    
                    filteredData = filteredData.filter(row => {
                        let budget = row['·Éë·Éò·É£·ÉØ·Éî·É¢·Éò_·Éö·Éê·É†·Éò'];
                        
                        // Handle different value formats
                        if (typeof budget === 'string') {
                            budget = parseFloat(budget.replace(/,/g, ''));
                        } else {
                            budget = parseFloat(budget);
                        }
                        
                        // Show rows with valid budget values that are within range
                        // OR show rows with invalid/missing budget based on a checkbox
                        const includeInvalid = true; // This could be a UI checkbox option in the future
                        return (includeInvalid && isNaN(budget)) || 
                            (!isNaN(budget) && budget >= minBudget && budget <= maxBudget);
                    });
                }
                
                // Apply students filter with min and max values
                const studentsMinSlider = document.getElementById('students-min-slider');
                const studentsMaxSlider = document.getElementById('students-max-slider');
                
                if (studentsMinSlider && studentsMaxSlider && 
                    !studentsMinSlider.parentElement.parentElement.parentElement.classList.contains('hidden')) {
                    
                    const minStudents = parseInt(studentsMinSlider.value);
                    const maxStudents = parseInt(studentsMaxSlider.value);
                    
                    filteredData = filteredData.filter(row => {
                        let students = row['·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê'];
                        
                        // Handle different value formats
                        if (typeof students === 'string') {
                            students = parseInt(students.replace(/,/g, ''));
                        } else {
                            students = parseInt(students);
                        }
                        
                        // Show rows with valid student values that are within range
                        // OR show rows with invalid/missing student count based on a checkbox
                        const includeInvalid = true; // This could be a UI checkbox option in the future
                        return (includeInvalid && isNaN(students)) || 
                            (!isNaN(students) && students >= minStudents && students <= maxStudents);
                    });
                }
                
                // Apply improved region filter - only apply if at least one checkbox is checked
                const regionCheckboxes = document.querySelectorAll('.region-checkbox:checked');
                if (regionCheckboxes.length > 0) {
                    const selectedRegions = Array.from(regionCheckboxes).map(cb => cb.value);
                    
                    // Check if unknown/empty option is selected
                    const includeUnknown = selectedRegions.includes('__unknown__');
                    
                    // Remove the special value from the list of actual regions
                    const selectedActualRegions = selectedRegions.filter(r => r !== '__unknown__');
                    
                    filteredData = filteredData.filter(row => {
                        const regionValue = row['·É†·Éî·Éí·Éò·Éù·Éú·Éò'];
                        
                        // Include if: region is in selected regions OR (it's empty/null AND include unknown is true)
                        return selectedActualRegions.includes(regionValue) || 
                            ((!regionValue || regionValue.trim() === '') && includeUnknown);
                    });
                }
                
                // Apply school type filter - only apply if at least one checkbox is checked
                const typeCheckboxes = document.querySelectorAll('.type-checkbox:checked');
                if (typeCheckboxes.length > 0) {
                    const selectedTypes = Array.from(typeCheckboxes).map(cb => cb.value);
                    filteredData = filteredData.filter(row => 
                        !row['·É°·Éô·Éù·Éö·Éò·É° ·É¢·Éò·Éû·Éò'] || selectedTypes.includes(row['·É°·Éô·Éù·Éö·Éò·É° ·É¢·Éò·Éû·Éò'])
                    );
                }
                
                // Apply facilities filters with new toggle buttons
                const facilityToggles = document.querySelectorAll('.facility-toggle');
                
                facilityToggles.forEach(toggle => {
                    const state = toggle.getAttribute('data-state');
                    const field = toggle.getAttribute('data-field');
                    
                    // Only apply filter if not in "all" state
                    if (state !== 'all') {
                        filteredData = filteredData.filter(row => {
                            const value = String(row[field] || '').trim().toLowerCase();
                            return (state === 'yes' && value === '·Éô·Éò') || 
                                (state === 'no' && value === '·Éê·É†·Éê');
                        });
                    }
                });
                
                // Apply name search
                const nameSearch = document.getElementById('name-search');
                if (nameSearch && nameSearch.value.trim()) {
                    const searchTerm = nameSearch.value.trim().toLowerCase();
                    filteredData = filteredData.filter(row => {
                        const schoolName = String(row['·É°·Éô·Éù·Éö·Éò·É° ·Éì·Éê·É°·Éê·ÉÆ·Éî·Éö·Éî·Éë·Éê'] || '').toLowerCase();
                        return schoolName.includes(searchTerm);
                    });
                }
                
                // Update grade distribution with filtered data
                setupGradeDistribution(filteredData);
                
                // Reset to first page
                currentPage = 1;
                
                // Update the display
                updateTable();
                updateSummaryStats();
            } catch (error) {
                console.error("Error applying filters:", error);
            }
        }

        function resetFilters() {
            try {
                // Reset budget sliders
                const budgetMinSlider = document.getElementById('budget-min-slider');
                const budgetMaxSlider = document.getElementById('budget-max-slider');
                if (budgetMinSlider && budgetMaxSlider) {
                    budgetMinSlider.value = budgetMinSlider.min;
                    budgetMaxSlider.value = budgetMaxSlider.max;
                    document.getElementById('budget-min-display').textContent = 
                        parseFloat(budgetMinSlider.min).toLocaleString();
                    document.getElementById('budget-max-display').textContent = 
                        parseFloat(budgetMaxSlider.max).toLocaleString();
                        
                    // Update the range visual
                    const budgetRange = document.getElementById('budget-range');
                    if (budgetRange) {
                        const percent1 = 0;
                        const percent2 = 100;
                        budgetRange.style.left = percent1 + '%';
                        budgetRange.style.width = (percent2 - percent1) + '%';
                    }
                }
                
                // Reset students sliders
                const studentsMinSlider = document.getElementById('students-min-slider');
                const studentsMaxSlider = document.getElementById('students-max-slider');
                if (studentsMinSlider && studentsMaxSlider) {
                    studentsMinSlider.value = studentsMinSlider.min;
                    studentsMaxSlider.value = studentsMaxSlider.max;
                    document.getElementById('students-min-display').textContent = 
                        parseInt(studentsMinSlider.min).toLocaleString();
                    document.getElementById('students-max-display').textContent = 
                        parseInt(studentsMaxSlider.max).toLocaleString();
                        
                    // Update the range visual
                    const studentsRange = document.getElementById('students-range');
                    if (studentsRange) {
                        const percent1 = 0;
                        const percent2 = 100;
                        studentsRange.style.left = percent1 + '%';
                        studentsRange.style.width = (percent2 - percent1) + '%';
                    }
                }
                
                // Reset region checkboxes to unchecked
                document.querySelectorAll('.region-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Reset type checkboxes to unchecked
                document.querySelectorAll('.type-checkbox').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Reset facility toggles to "all" state
                document.querySelectorAll('.facility-toggle').forEach(toggle => {
                    toggle.setAttribute('data-state', 'all');
                    toggle.querySelector('.status').textContent = '·Éß·Éï·Éî·Éö·Éê';
                });
                
                // Reset name search
                document.getElementById('name-search').value = '';
                
                // Apply the reset filters
                filteredData = [...originalData];
                
                // Update grade distribution with original data
                setupGradeDistribution(originalData);
                
                // Reset pagination
                currentPage = 1;
                
                // Update the display
                updateTable();
                updateSummaryStats();
            } catch (error) {
                console.error("Error resetting filters:", error);
            }
        }
        function updateSummaryStats() {
            try {
                // Update summary statistics
                document.getElementById('total-schools').textContent = originalData.length.toLocaleString();
                document.getElementById('filtered-schools').textContent = filteredData.length.toLocaleString();
                
                // Calculate percentage
                const percentage = originalData.length > 0 
                    ? Math.round((filteredData.length / originalData.length) * 100) 
                    : 0;
                
                document.getElementById('filtered-percentage').textContent = `(${percentage}%)`;
                
                // Calculate total students
                let totalStudents = 0;
                filteredData.forEach(row => {
                    if (row['·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê']) {
                        totalStudents += parseInt(row['·Éõ·Éù·É°·É¨·Éê·Éï·Éö·Éî·Éî·Éë·Éò·É° ·É†·Éê·Éù·Éì·Éî·Éú·Éù·Éë·Éê']) || 0;
                    }
                });
                
                document.getElementById('total-students').textContent = totalStudents.toLocaleString();
                
                // Calculate average budget
                let totalBudget = 0;
                let budgetCount = 0;
                
                filteredData.forEach(row => {
                    if (row['·Éë·Éò·É£·ÉØ·Éî·É¢·Éò_·Éö·Éê·É†·Éò']) {
                        const budget = parseFloat(row['·Éë·Éò·É£·ÉØ·Éî·É¢·Éò_·Éö·Éê·É†·Éò']);
                        if (!isNaN(budget)) {
                            totalBudget += budget;
                            budgetCount++;
                        }
                    }
                });
                
                const avgBudget = budgetCount > 0 ? Math.round(totalBudget / budgetCount) : 0;
                document.getElementById('avg-budget').textContent = avgBudget.toLocaleString();
            } catch (error) {
                console.error("Error updating summary stats:", error);
            }
        }
        
        function exportFilteredData() {
            try {
                if (filteredData.length === 0) {
                    alert('·Éê·É† ·Éê·É†·Éò·É° ·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò ·Éî·É•·É°·Éû·Éù·É†·É¢·Éò·É°·Éó·Éï·Éò·É°');
                    return;
                }
                
                // Get all columns from the first row
                const headers = Object.keys(filteredData[0])
                    .filter(key => !key.startsWith('Unnamed:'))
                    .join(',');
                    
                const rows = filteredData.map(row => {
                    return Object.keys(row)
                        .filter(key => !key.startsWith('Unnamed:'))
                        .map(key => {
                            // Quote strings that contain commas
                            const value = row[key];
                            if (typeof value === 'string' && value.includes(',')) {
                                return `"${value}"`;
                            }
                            return value;
                        })
                        .join(',');
                }).join('\n');
                
                const csv = headers + '\n' + rows;
                
                // Create blob and download link
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', 'filtered_school_data.csv');
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } catch (error) {
                console.error("Error exporting data:", error);
                alert("·Éõ·Éù·Éú·Éê·É™·Éî·Éõ·Éî·Éë·Éò·É° ·Éî·É•·É°·Éû·Éù·É†·É¢·Éò·É°·Éê·É° ·Éõ·Éù·ÉÆ·Éì·Éê ·É®·Éî·É™·Éì·Éù·Éõ·Éê: " + error.message);
            }
        }
    </script>
</body>
</html>
